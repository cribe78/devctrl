var DevCtrl={EnumSelect:{}};
DevCtrl.EnumSelect.Directive=["DataService",function(a){return{scope:{tableName:"=table",field:"=",selectModel:"="},bindToController:!0,controller:function(a){this.enums=a.getTable("enums");this.enumVals=a.getTable("enum_vals");this.schema=a.getSchema(this.tableName);this.enumId=function(){var a=0,d=this.tableName+"."+this.field.name;angular.forEach(this.enums.indexed,function(b,f){b.fields.name==d&&(a=f)});return a};this.options=function(){var a=this.enumId(),d={};0<a&&(d=this.enums.indexed[a].referenced.enum_vals);
return d}},controllerAs:"enumSelect",templateUrl:"ng/enum-select.html"}}];DevCtrl.SwitchSet={};
DevCtrl.SwitchSet.Directive=["DataService",function(a){return{scope:!0,bindToController:{control:"="},controller:function(a){var c=this,d={},b={};this.setAll=function(b){angular.forEach(d,function(d,c){d.fields.value=b;a.updateControlValue(d)})};this.slaveControls=function(){angular.forEach(c.control.referenced.control_sets,function(a,c){b[a.foreign.slave_control_id.id]=a.fields.name;d[a.foreign.slave_control_id.id]=a.foreign.slave_control_id});return d};this.slaveName=function(a){return b[a.id]};this.updateCtrlValue=
function(b){a.updateControlValue(b)}},controllerAs:"switchSet",templateUrl:"ng/switch-set.html"}}];DevCtrl.stateConfig=["$stateProvider","$locationProvider","$urlRouterProvider",function(a,e,c){a.state("rooms",{url:"/rooms",scope:!0,controller:function(a,b){this.foo="bar";this.$state=b},controllerAs:"roomsCtrl",templateUrl:"ng/locations.html",resolve:{state:"$state"},data:{title:"Locations"}}).state("rooms.room",{url:"/:name",templateUrl:"ng/room.html",controller:"RoomCtrl",controllerAs:"room",resolve:DevCtrl.Room.Resolve,data:{listByName:"rooms"}}).state("config",{"abstract":!0,url:"/config",
template:"<ui-view />",data:{title:"Configuration"}}).state("config.data",{url:"/data",templateUrl:"ng/data.html",resolve:{$state:"$state"},data:{title:"Table Data"}}).state("config.data.table",{url:"/:table",templateUrl:"ng/tableeditor.html",controller:"TableCtrl",controllerAs:"table",resolve:DevCtrl.Table.Resolve});c.when("/","/rooms");e.html5Mode(!0)}];DevCtrl.Room={};
DevCtrl.Room.Ctrl=["$stateParams","DataService",function(a,e){var c=this;this.roomName=a.name;this.rooms=e.getTable("rooms");angular.forEach(this.rooms.listed,function(a){a.fields.name==c.roomName&&(c.obj=a,c.id=a.id)});this.panels=this.obj.referenced.panels;this.panelControls=function(a){if(angular.isDefined(a.referenced.panel_controls))return a.referenced.panel_controls};this.togglePanel=function(a){angular.isDefined(a.opened)?a.opened=!a.opened:a.opened=!0};this.isPanelOpen=function(a){return angular.isDefined(a.opened)&&a.opened}}];
DevCtrl.Room.Resolve={loadControls:function(a){return a.getTablePromise("controls")},loadControlTemplates:function(a){return a.getTablePromise("control_templates")},loadRooms:function(a){return a.getTablePromise("rooms")},loadPanels:function(a){return a.getTablePromise("panels")},loadPanelControls:function(a){return a.getTablePromise("panel_controls")},loadControlSets:function(a){return a.getTablePromise("control_sets")}};DevCtrl.DataService={};
DevCtrl.DataService.factory=["$http","$mdToast","$timeout","socketFactory",function(a,e,c,d){var b={},f={},g=io("https://devctrl.dwi.ufl.edu/");d=d({ioSocket:g});var h={},k={messenger:d,dataModel:b,addRow:function(b){var c=this;a.post("data.php",b).success(function(a){c.loadData(a);angular.forEach(b,function(a,c){"table"!=c&&(b[c]=null)})}).error(function(a){c.errorToast(a)})},deleteRow:function(b){var c=this;a.delete("data.php/"+b.tableName+"/"+b.id).success(function(a){c.loadData(a)}).error(function(a){c.errorToast(a)})},errorToast:function(a){var b=
"An unknown error has occured";angular.isDefined(a.error)&&(b=a.error);e.show(e.simple().content(b))},getRowRef:function(a,b){if(!angular.isDefined(a))return console.error("error looking up record for undefined table"),{};if(!angular.isDefined(b)||null===b)return console.error("error looking up %s record for undefined key",a),{};var c=this.getTableRef(a);if(angular.isString(f[a].pk))return angular.isDefined(c.indexed[b])||(c.indexed[b]={fields:{},foreign:{},id:b,loaded:!1,referenced:{},tableName:a},
c.listed.push(c.indexed[b])),c.indexed[b];console.error("multi column keys not supported, table %s",a)},getMenu:function(){var c=this;angular.isDefined(b.menu)||(b.menu={items:{}},a.get("menu.php").success(function(a){angular.isDefined(a.menu.items)?(console.log("test/menu.php loaded"),b.menu.items=a.menu.items):console.log("test/menu.php did not return a valid menu object")}).error(function(a){c.errorToast(a)}));return b.menu},getSchema:function(b){var c=this;angular.isDefined(f[b])||(c.getSchemaRef(b),
a.get("schema.php").success(function(a){angular.isDefined(a.schema)&&angular.forEach(a.schema,function(a,b){var d=c.getSchemaRef(b);angular.merge(d,a);angular.isDefined(d.foreign_keys)&&angular.forEach(d.foreign_keys,function(a,b){d.referenced[a]=b})})}).error(function(a){c.errorToast(a)}));return f[b]},getSchemaRef:function(a){angular.isDefined(f[a])||(f[a]={referenced:{},foreign_keys:{}});return f[a]},getSchemas:function(){this.getSchema("controls");return f},getTable:function(a){angular.isDefined(b[a])?
b[a].loaded||(b[a].loaded="pending",this.getTablePromise(a)):(this.getTableRef(a),this.getTablePromise(a));return b[a]},getTablePromise:function(b){var c=this;if(angular.isDefined(b))return a.get("data.php?table="+b).success(function(a){c.loadData(a)}).error(function(a){c.errorToast(a)});console.error("error: attempt to fetch undefined table!")},getTableRef:function(a){angular.isDefined(b[a])||(b[a]={listed:[],indexed:{},loaded:!1});return b[a]},loadData:function(a){var c=this;angular.isDefined(a.update)&&
angular.forEach(a.update,function(a,b){angular.forEach(a,function(a,d){var e=c.getRowRef(b,d);angular.merge(e.fields,a)})});angular.isDefined(a.add)&&angular.forEach(a.add,function(a,d){var e=c.getSchema(d),f=e.pk,k=e.foreign_keys;angular.forEach(a,function(a,b){if(angular.isString(f)){var e=c.getRowRef(d,b);angular.merge(e.fields,a);e.loaded=!0;angular.forEach(k,function(a,b){if(null!==e.fields[b]){var f=c.getRowRef(a,e.fields[b]);angular.isDefined(f.referenced[d])||(f.referenced[d]={});f.referenced[d][e.id]=
e;e.foreign[a]=f;e.foreign[b]=f}else e.foreign[a]=null,e.foreign[b]=null})}else console.error("Error loading %s, multi-keyed records not supported",d)});b[d].loaded="loaded"});angular.isDefined(a.delete)&&angular.forEach(a.delete,function(a,d){var e=c.getSchema(d).pk;angular.forEach(a,function(a,c){angular.isString(e)?delete b[d].indexed[c]:angular.forEach(a,function(a,e){delete b[d].indexed[c][e]})});b[d].listed.length=0;angular.forEach(b[d].indexed,function(a,c){angular.isString(e)?b[d].listed.push(a):
angular.forEach(a,function(a){b[d].listed.push(a)})})})},updateControlValue:function(b){angular.isDefined(h[b.id])&&c.cancel(h[b.id]);h[b.id]=c(function(b,c){var d="control.php/"+b.id;pendingDebounce=!1;a.put(d,b.fields).success(function(a){c.loadData(a)}).error(function(a){c.errorToast(a)})},200,!0,b,this)},updateRow:function(b){var c=this;a.put("data.php/"+b.tableName+"/"+b.id,b.fields).success(function(a){c.loadData(a)}).error(function(a){c.errorToast(a)})}};d.on("control-data",function(a){k.loadData(a)});
return k}];DevCtrl.Menu={};DevCtrl.Menu.Directive=["MenuService","$state",function(a,e){return{scope:!0,bindToController:{},controller:function(a,d){this.service=a},controllerAs:"menu",templateUrl:"ng/menu.html"}}];DevCtrl.Record={};DevCtrl.Record.Ctrl=["DataService",function(a){this.obj=this.table.data.indexed[this.id];this.schema=this.table.schema;var e=this;this.deleteRow=function(){a.deleteRow(e.obj);this.table.closeRecord()};this.updateRow=function(){a.updateRow(e.obj);this.table.closeRecord()};this.cloneRow=function(){var c=angular.copy(e.obj.fields);c.table=e.obj.tableName;a.addRow(c);this.table.closeRecord()};this.close=function(){this.table.closeRecord()}}];
DevCtrl.Record.Resolve={loadTable:["tableName","DataService",function(a,e){return e.getTablePromise(a)}]};DevCtrl.MainCtrl=["$state","$mdSidenav","DataService","MenuService",function(a,e,c,d){this.msg="Hello World!";this.tiles=[{img:"/images/orc.png"},{img:"/images/pict.png"},{img:"/images/sage.png"}];this.menu=d;this.schema=c.getSchemas();this.toggleSidenav=function(a){e(a).toggle()};this.go=function(b){angular.isString(b)?a.go(b):a.go(b.name,b.params)};this.dataModel=c.dataModel;this.title="DevCtrl";this.top=!0}];DevCtrl.Ctrl={};
DevCtrl.Ctrl.Directive=["DataService",function(a){return{scope:{panelControl:"="},bindToController:!0,controller:function(a){this.ctrl=this.panelControl.foreign.controls;this.template=this.ctrl.foreign.control_templates;this.name=this.panelControl.fields.name;this.type=this.template.fields.usertype;this.enums=a.getTable("enums");this.enumVals=a.getTable("enum_vals");var c=this;this.normalizedValue=function(){var a=c.ctrl.fields.value,b=c.template.fields.max,e=c.template.fields.min,a=a<e?e:a;return((a>
b?b:a)+(0-e))*(b-e)/100};this.updateValue=function(){a.updateControlValue(c.ctrl)};this.selectMenuItem=function(a){c.ctrl.fields.value=a;c.updateValue()};this.selectOptions=function(){var a=c.ctrl.fields.enum_id,b={};0<a&&(b=c.enums.indexed[a].referenced.enum_vals);return b}},controllerAs:"ctrl",templateUrl:"ng/ctrl.html"}}];DevCtrl.FkSelect={};DevCtrl.FkSelect.Directive=["DataService",function(a){return{scope:{tableName:"=table",field:"=",selectModel:"="},bindToController:!0,controller:function(a){this.options=a.getTable(this.tableName);this.schema=a.getSchema(this.tableName)},controllerAs:"fkSelect",templateUrl:"ng/fk-select.html"}}];DevCtrl.Table={};
DevCtrl.Table.Ctrl=["$scope","$stateParams","$mdDialog","DataService",function(a,e,c,d){this.tableName=e.table;this.data=d.getTable(this.tableName);this.schema=d.getSchema(this.tableName);this.newRow={table:this.tableName};d.messenger.emit("status-update",{message:"table "+this.tableName+" loaded"});this.addRow=function(){d.addRow(this.newRow)};this.deleteRow=function(a){a.table=this.tableName;d.deleteRow(a)};this.fkDisplayVal=function(a,b){var c=d.getSchema(this.schema.foreign_keys[a.name]);if(!angular.isDefined(b.foreign[a.name]))return"";
var e=b.foreign[a.name];if(null==e)return"NULL";var l=e.id;angular.isDefined(e.fields[c.fk_name])&&(l=e.fields[c.fk_name]);return l};var b=this;this.openRecord=function(a,d){c.show({targetEvent:a,locals:{id:d,table:b},controller:DevCtrl.Record.Ctrl,controllerAs:"record",bindToController:!0,templateUrl:"ng/record.html",clickOutsideToClose:!0,hasBackdrop:!1})};this.closeRecord=function(){c.hide()}}];DevCtrl.Table.Resolve={tableName:["$stateParams",function(a){return a.table}]};DevCtrl.MenuService={};
DevCtrl.MenuService.factory=["$state","DataService",function(a,e){var c={pageTitle:function(){return a.current.title||a.params.name},parentState:"root",items:{},states:function(){return a.get()},menuItems:function(){var d=a.get();angular.forEach(d,function(b,d){""!=b.name&&(b.isOpened=a.includes(b),""==a.get("^",b).name&&(c.items[b.name]=b,angular.isDefined(b.substates)||(b.substates={})),angular.isDefined(b.data.title)&&(b.title=b.data.title))});angular.forEach(d,function(b,d){if(""!=b.name){var g=
a.get("^",b);if(angular.isDefined(c.items[g.name]))if(angular.isDefined(b.data.listByName)){var h=e.getTable(b.data.listByName).listed;angular.forEach(h,function(a){angular.isDefined(g.substates[a.id])?(g.substates[a.id].params.name=a.fields.name,g.substates[a.id].title=a.fields.name):g.substates[a.id]={name:b.name,params:{name:a.fields.name},title:a.fields.name}})}else c.items[g.name].substates[b.name]=b}});return c.items}};return c}];DevCtrl.App=angular.module("DevCtrlApp",["ui.router","ngMaterial","btford.socket-io"]).factory("DataService",DevCtrl.DataService.factory).factory("MenuService",DevCtrl.MenuService.factory).directive("ctrl",DevCtrl.Ctrl.Directive).directive("coeMenu",DevCtrl.Menu.Directive).directive("fkSelect",DevCtrl.FkSelect.Directive).directive("enumSelect",DevCtrl.EnumSelect.Directive).directive("switchSet",DevCtrl.SwitchSet.Directive).controller("MainCtrl",DevCtrl.MainCtrl).controller("TableCtrl",DevCtrl.Table.Ctrl).controller("RecordCtrl",
DevCtrl.Record.Ctrl).controller("RoomCtrl",DevCtrl.Room.Ctrl).config(DevCtrl.stateConfig).run(["$rootScope",function(a){a.$on("$stateChangeStart",function(a,c,d,b,f){console.log("$stateChangeStart to "+c.to+"- fired when the transition begins. toState,toParams : \n",c,d)});a.$on("$stateChangeError",function(a,c,d,b,f){console.log("$stateChangeError - fired when an error occurs during transition.");console.log(arguments)});a.$on("$stateChangeSuccess",function(a,c,d,b,f){console.log("$stateChangeSuccess to "+
c.name+"- fired once the state transition is complete.")});a.$on("$viewContentLoaded",function(a){console.log("$viewContentLoaded - fired after dom rendered",a)});a.$on("$stateNotFound",function(a,c,d,b){console.log("$stateNotFound "+c.to+"  - fired when a state cannot be found by its name.");console.log(c,d,b)})}]);
